<div class="row justify-content-center">
  <div class="col-6">
    <div class="card">
      <form class="card-body text-center needs-validation" novalidate>
        <div class="card-title">
          <h4 class="border-bottom pb-2 mb-4">Account Login</h4>
        </div>
        <div class="card-text">
          <div id="auth-error" class="alert alert-danger d-none" role="alert">
            The username or password is invalid
          </div>
          <div class="form-group">
            <label class="font-weight-bold text-dark" for="username">Username</label>
            <input id="username" class="form-control" type="text" autocomplete="off" required /> <!-- is-invalid -->
            <div class="invalid-feedback">Please provide a username</div>
          </div>
          <div class="form-group">
            <label class="font-weight-bold text-dark" for="password">Password</label>
            <input id="password" class="form-control" type="password" autocomplete="off" required />
            <div class="invalid-feedback">Please provide a password</div>
          </div>
          <div class="form-group form-check">
            <input type="checkbox" class="form-check-input" id="remember">
            <label class="form-check-label text-dark" for="remember">Remember Me</label>
          </div>
          <button id="login-btn" class="btn btn-dark" type="submit">Log In</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.18.0/axios.min.js"></script>
<script>
  (function() {
    'use strict';

    window.addEventListener('load', function() {
      const forms = document.getElementsByClassName('needs-validation');

      const setLoadingBtn = (id, text) => {
        const btn = document.querySelector(id);
        btn.setAttribute('disabled', true);
        btn.innerHTML = `
          <span class="spinner-grow spinner-grow-sm" role="status" aria-hidden="true"></span> ${text}
        `;
      };

      const unsetLoadingButton = (id, text) => {
        const btn = document.querySelector(id);
        btn.removeAttribute('disabled');
        btn.innerHTML = text;
      }

      var validation = Array.prototype.filter.call(forms, function(form) {
        form.addEventListener('submit', function(event) {

          setLoadingBtn('#login-btn', 'Logging In...');

          if (form.checkValidity() === false) {
            event.preventDefault();
            event.stopPropagation();
            unsetLoadingButton('#login-btn', 'Log In');
          } else {
            event.preventDefault();
            axios.post('http://localhost:9000/user/authenticate', {
              username: document.querySelector('#username').value,
              password: document.querySelector('#password').value,
            })
            .then(res => {
              const { auth, token } = res.data;

              if (auth === true) {
                const now = new Date();
                now.setTime(now.getTime() + 1 * 3600 * 1000);

                document.cookie = `userToken=${token}; expires=${now.toUTCString()} path=/;`;
                location.href = '/account/dashboard';
              } else {
                unsetLoadingButton('#login-btn', 'Log In');
                document.querySelector('#auth-error').classList.remove('d-none');
              }
            })
            .catch(err => {
              console.log(err);
              unsetLoadingButton('#login-btn', 'Log In');
            });
          }
          form.classList.add('was-validated');
          
        }, false);
      });

    }, false);

  })();
</script>
